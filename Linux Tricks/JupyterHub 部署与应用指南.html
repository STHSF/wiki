<!DOCTYPE HTML>
<html>
<head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <title>JupyterHub 部署与应用指南 - LiYu's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Economics"/>
    <meta name="description" content="A wiki website of sthsf when I learned new knowledgy and technics."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width" />

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
        });
        </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-78529611-1', 'auto');
        ga('send', 'pageview');

    </script>
</head>

<body>
<div id="container">
    
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#Linux Tricks">Linux Tricks</a>&nbsp;»&nbsp;JupyterHub 部署与应用指南</div>
</div>
<div class="clearfix"></div>
<div id="title">JupyterHub 部署与应用指南</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#1jupyterhub-on-kubernetes">1、JupyterHub on Kubernetes部署与应用指南</a></li>
<li><a href="#jupyterhub">jupyterHub 安装</a><ul>
<li><a href="#1virtualenv">1、virtualenv 下安装与配置</a><ul>
<li><a href="#jupyterhub_1">安装jupyterhub</a></li>
<li><a href="#jupyterhub_2">配置jupyterhub</a></li>
<li><a href="#_1">创建多用户</a></li>
<li><a href="#env-jupyterhub">用户下创建env虚拟环境, 并且添加到jupyterhub中</a></li>
<li><a href="#jupyterhub_3">jupyterhub的启动配置</a></li>
<li><a href="#nohup">使用nohup让程序在后台运行.</a></li>
<li><a href="#_2">开机运行</a></li>
<li><a href="#jupyterhub_4">jupyterhub启用代理</a></li>
</ul>
</li>
<li><a href="#2docker-jupyterhub">2、Docker 下安装配置jupyterhub</a><ul>
<li><a href="#1pull-ubuntu">1、pull 一个纯净的ubuntu环境</a></li>
<li><a href="#2ubuntu-docker">2、进入ubuntu docker, 安装相关软件, 这里仅考虑安装的最基本的应用需求, 其他需要自行下载.</a></li>
<li><a href="#3python3">3、安装基于python3的虚拟环境</a></li>
<li><a href="#4-pipjupyterhub">4、配置好之后进入虚拟环境, 使用pip安装和生成jupyterhub配置文件, 同第一节中的安装方式.</a></li>
<li><a href="#5jupyterhub">5、在配置文件目录下运行jupyterhub,其他配置没有改变,结束.</a></li>
<li><a href="#docker">Docker镜像</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jupyterhubtensorflow-gpu">jupyterhub下使用tensorflow-gpu产生的错误</a></li>
<li><a href="#_3">参考文献</a></li>
</ul>
</div>
<h1 id="1jupyterhub-on-kubernetes">1、JupyterHub on Kubernetes部署与应用指南</h1>
<h1 id="jupyterhub">jupyterHub 安装</h1>
<h2 id="1virtualenv">1、virtualenv 下安装与配置</h2>
<h3 id="jupyterhub_1">安装jupyterhub</h3>
<p>在装好的虚拟环境下安装jupyterhub,首先要保证使用的python版本是3.0以上的版本,官方说明只支持3.0以上的版本.</p>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">jupyterhub</span>
</pre></div>


<p>在使用pip安装的时候需要安装nodejs/npm，</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">npm</span> <span class="n">nodejs</span><span class="o">-</span><span class="n">legacy</span>
</pre></div>


<p>如果想要在本地运行notebook服务,还需要在本地安装jupyter notebook包</p>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">notebook</span>
</pre></div>


<h3 id="jupyterhub_2">配置jupyterhub</h3>
<div class="hlcode"><pre><span class="n">jupyterhub</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span>
</pre></div>


<p>这时候当前目录相面会生成<code>jupyterhub_config.py</code>的配置文件.<br />
注, 如果想要在某个文件目录下生成,则需要在那个文件目录下运行上面的文件.</p>
<p>生成配置文件之后,可以进行适当的配置, 如</p>
<div class="hlcode"><pre><span class="cp"># 端口和ip</span>
<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">ip</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">IP</span><span class="err">地址&#39;</span>
<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="err">端口</span>
</pre></div>


<p>配置完成之后, 启动<code>jupyterhub</code>, 可能会遇到下面的问题:</p>
<div class="hlcode"><pre><span class="o">[</span>E 2019-08-12 17:12:53.624 JupyterHub proxy:658<span class="o">]</span> Failed to find proxy <span class="o">[</span><span class="s1">&#39;configurable-http-proxy&#39;</span><span class="o">]</span>
    The proxy can be installed with <span class="sb">`</span>npm install -g configurable-http-proxy<span class="sb">`</span>.To install <span class="sb">`</span>npm<span class="sb">`</span>, install nodejs which includes <span class="sb">`</span>npm<span class="sb">`</span>.If you see an <span class="sb">`</span>EACCES<span class="sb">`</span> error or permissions error, refer to the <span class="sb">`</span>npm<span class="sb">`</span> documentation on How To Prevent Permissions Errors.
<span class="o">[</span>C 2019-08-12 17:12:53.624 JupyterHub app:2349<span class="o">]</span> Failed to start proxy
    Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
      File <span class="s2">&quot;/home/gpyz/venv/xgb/lib/python3.5/site-packages/jupyterhub/app.py&quot;</span>, line 2347, in start
        await self.proxy.start<span class="o">()</span>
      File <span class="s2">&quot;/home/gpyz/venv/xgb/lib/python3.5/site-packages/jupyterhub/proxy.py&quot;</span>, line 650, in start
        cmd, <span class="nv">env</span><span class="o">=</span>env, <span class="nv">start_new_session</span><span class="o">=</span>True, <span class="nv">shell</span><span class="o">=</span>shell
      File <span class="s2">&quot;/usr/lib/python3.5/subprocess.py&quot;</span>, line 947, in __init__
        restore_signals, start_new_session<span class="o">)</span>
      File <span class="s2">&quot;/usr/lib/python3.5/subprocess.py&quot;</span>, line 1551, in _execute_child
        raise child_exception_type<span class="o">(</span>errno_num, err_msg<span class="o">)</span>
    FileNotFoundError: <span class="o">[</span>Errno 2<span class="o">]</span> No such file or directory: <span class="s1">&#39;configurable-http-proxy&#39;</span>
</pre></div>


<p>则需要参考下面的操作:</p>
<div class="hlcode"><pre><span class="cp"># 参考github上jupyterhub的说明, 在/opt/nodejs 目录中安装</span>
<span class="n">npm</span> <span class="n">install</span> <span class="o">-</span><span class="n">g</span> <span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span>
<span class="err">注</span><span class="p">,</span> <span class="err">当然</span><span class="p">,</span><span class="err">不一定在</span><span class="n">opt</span><span class="err">目录下面</span><span class="p">,</span> <span class="err">可以通过</span><span class="n">whereis</span> <span class="n">nodejs</span><span class="p">,</span><span class="err">查看你所安装的</span><span class="n">nodejs</span><span class="err">所在的位置</span><span class="p">,</span><span class="err">我的文件就保存在&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nodejs</span><span class="o">/</span><span class="n">node</span><span class="o">-</span><span class="n">v10</span><span class="mf">.15.0</span><span class="o">/</span><span class="n">bin</span><span class="err">&#39;下</span>

<span class="n">c</span><span class="p">.</span><span class="n">JupyterHub</span><span class="p">.</span><span class="n">proxy_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">nodejs</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="err">&#39;</span><span class="p">,]</span>

<span class="n">ps</span><span class="p">,</span> <span class="err">环境变量中如果配置了</span><span class="n">node</span><span class="err">的路径</span><span class="p">,</span><span class="err">这边可以忽略</span>
</pre></div>


<div class="hlcode"><pre><span class="cp"># 设置默认登陆jupyterhub后的目录,这是相对目录,用户登陆后会在当前用户的/notebook文件夹下,如果用户没有/notebook这个文件夹,启动过程可能会失败</span>
<span class="n">c</span><span class="p">.</span><span class="n">Spawner</span><span class="p">.</span><span class="n">notebook_dir</span> <span class="o">=</span> <span class="err">&#39;</span><span class="o">~/</span><span class="n">notebook</span><span class="err">&#39;</span>

<span class="cp"># 该方式设置了绝对路径,所有用户登陆jupyterhub的时候,都会在&#39;/home/ubuntu/notebook/&#39;这个目录下</span>
<span class="n">c</span><span class="p">.</span><span class="n">Spawner</span><span class="p">.</span><span class="n">notebook_dir</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">home</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">notebook</span><span class="err">&#39;</span>
</pre></div>


<h3 id="_1">创建多用户</h3>
<p>首先除了当前root用户之外,我们还可以新建其他的用户作为普通用户,这个还是跟linux下添加用户一样</p>
<div class="hlcode"><pre><span class="n">adduser</span> <span class="n">user1</span>
</pre></div>


<p>根据系统提示,设置密码和身份等东西.</p>
<p>设置完成之后在配置文件中添加相应的设置</p>
<div class="hlcode"><pre><span class="mi">1</span><span class="err">、添加普通用户</span>
<span class="n">c</span><span class="p">.</span><span class="n">Authenticator</span><span class="p">.</span><span class="n">whitelist</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">user1</span><span class="err">&#39;</span><span class="p">}</span>

<span class="mi">2</span><span class="err">、添加管理员</span>
<span class="n">c</span><span class="p">.</span><span class="n">Authenticator</span><span class="p">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">ubuntu</span><span class="err">&#39;</span><span class="p">}</span>
</pre></div>


<h3 id="env-jupyterhub">用户下创建env虚拟环境, 并且添加到jupyterhub中</h3>
<p>step1、首先在当前用户下使用<code>virtualenv</code>创建本地虚拟环境</p>
<p>step2、该虚拟环境下安装ipykernel</p>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">ipykernel</span>
</pre></div>


<p>step3、 安装完ipykernel之后执行下面的命令</p>
<div class="hlcode"><pre><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">ipykernel</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">name</span> <span class="p">[</span><span class="err">环境名</span><span class="p">]</span><span class="o">--</span><span class="n">display</span><span class="o">-</span><span class="n">name</span> <span class="p">[</span><span class="err">简称</span><span class="p">]</span>
</pre></div>


<p>例如</p>
<div class="hlcode"><pre><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">ipykernel</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">name</span>  <span class="n">python_basic</span> <span class="o">--</span><span class="n">display</span><span class="o">-</span><span class="n">name</span> <span class="n">basic</span>
</pre></div>


<p>然后重启当前用户的jupyterhubserver就可以看到该环境了</p>
<h3 id="jupyterhub_3">jupyterhub的启动配置</h3>
<h3 id="nohup">使用nohup让程序在后台运行.</h3>
<p>注, 运行时好像需要在root用户下运行,其他用户运行可能会导致有的用户启动不了.如果想要使用sudo运行而不用root用户运行,可以参考<a href="https://github.com/jupyterhub/jupyterhub/wiki/Using-sudo-to-run-JupyterHub-without-root-privileges">Using sudo to run JupyterHub without root privileges</a></p>
<div class="hlcode"><pre><span class="n">nohup</span> <span class="n">jupyterhub</span> <span class="o">&gt;</span> <span class="n">jupyterhub</span><span class="p">.</span><span class="n">log</span> <span class="o">&amp;</span>
</pre></div>


<h3 id="_2">开机运行</h3>
<p>开机配置</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">cat</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">jupyterhub</span><span class="p">.</span><span class="n">service</span>  
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Jupyterhub</span>
<span class="n">After</span><span class="o">=</span><span class="n">syslog</span><span class="p">.</span><span class="n">target</span> <span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">User</span><span class="o">=</span><span class="n">root</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">xyq</span><span class="o">/</span><span class="p">.</span><span class="n">jupyter</span><span class="o">/</span><span class="n">run_hub</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
</pre></div>


<p>启动</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">jupyterhub</span> <span class="err">#</span> <span class="err">开机自启动</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>     <span class="err">#</span> <span class="err">加载配置文件</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">jupyterhub</span>  <span class="err">#</span> <span class="err">启动</span>
<span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">jupyterhub</span>    <span class="err">#</span> <span class="err">查看</span><span class="n">log</span>
</pre></div>


<h3 id="jupyterhub_4">jupyterhub启用代理</h3>
<p>为了方便安全使用, 下面介绍使用nginx代理</p>
<div class="hlcode"><pre><span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="mi">443</span> <span class="n">ssl</span> <span class="n">http2</span><span class="p">;</span>
    <span class="n">listen</span> <span class="p">[</span><span class="o">::</span><span class="p">]</span><span class="o">:</span><span class="mi">443</span> <span class="n">ssl</span> <span class="n">http2</span><span class="p">;</span>

    <span class="n">resolver</span> <span class="mf">192.168.2.1</span> <span class="mf">114.114.114.114</span><span class="p">;</span>
    <span class="n">set</span> <span class="err">$</span><span class="n">backend</span> <span class="s">&quot;https://jp.abcgogo.com:12443&quot;</span><span class="p">;</span>

    <span class="n">server_name</span> <span class="n">jp</span><span class="p">.</span><span class="n">abcgogo</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>

    <span class="n">ssl_certificate</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">syno</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">certificate</span><span class="o">/</span><span class="n">ReverseProxy</span><span class="o">/</span><span class="n">faea4d05</span><span class="o">-</span><span class="mi">2458</span><span class="o">-</span><span class="mf">4ff</span><span class="n">c</span><span class="o">-</span><span class="n">acfe</span><span class="o">-</span><span class="n">e4b48e5a04f9</span><span class="o">/</span><span class="n">fullchain</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span>

    <span class="n">ssl_certificate_key</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">syno</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">certificate</span><span class="o">/</span><span class="n">ReverseProxy</span><span class="o">/</span><span class="n">faea4d05</span><span class="o">-</span><span class="mi">2458</span><span class="o">-</span><span class="mf">4ff</span><span class="n">c</span><span class="o">-</span><span class="n">acfe</span><span class="o">-</span><span class="n">e4b48e5a04f9</span><span class="o">/</span><span class="n">privkey</span><span class="p">.</span><span class="n">pem</span><span class="p">;</span>

    <span class="n">add_header</span> <span class="n">Strict</span><span class="o">-</span><span class="n">Transport</span><span class="o">-</span><span class="n">Security</span> <span class="s">&quot;max-age=15768000; includeSubdomains; preload&quot;</span> <span class="n">always</span><span class="p">;</span>

    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">proxy_set_header</span>        <span class="n">Host</span>                <span class="err">$</span><span class="n">http_host</span><span class="p">;</span>
        <span class="n">proxy_set_header</span>        <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span>           <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
        <span class="n">proxy_set_header</span>        <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span>     <span class="err">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="n">proxy_set_header</span>        <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Proto</span>   <span class="err">$</span><span class="n">scheme</span><span class="p">;</span>
        <span class="n">proxy_intercept_errors</span>  <span class="n">on</span><span class="p">;</span>
    <span class="err">#</span> <span class="n">WebSocket</span> <span class="n">support</span>
        <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
        <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> <span class="err">$</span><span class="n">http_upgrade</span><span class="p">;</span>
        <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s">&quot;upgrade&quot;</span><span class="p">;</span>

        <span class="n">proxy_read_timeout</span> <span class="mi">120</span><span class="n">s</span><span class="p">;</span>
        <span class="n">proxy_next_upstream</span> <span class="n">error</span><span class="p">;</span>

        <span class="n">proxy_pass</span> <span class="err">$</span><span class="n">backend</span><span class="p">;</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>


<h2 id="2docker-jupyterhub">2、Docker 下安装配置jupyterhub</h2>
<h4 id="1pull-ubuntu">1、pull 一个纯净的ubuntu环境</h4>
<h4 id="2ubuntu-docker">2、进入ubuntu docker, 安装相关软件, 这里仅考虑安装的最基本的应用需求, 其他需要自行下载.</h4>
<div class="hlcode"><pre><span class="n">python3</span>
<span class="n">vim</span>
</pre></div>


<p>docker下的应用的安装和使用可以参见<a href="https://sthsf.github.io/wiki/Linux%20Tricks/docker%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B.html">Docker使用教程</a>和<a href="https://sthsf.github.io/wiki/Linux%20Tricks/python3.5%E5%8D%87%E7%BA%A7%E5%88%B0python3.6.html">python3.5升级到python3.6</a>中的相关内容.</p>
<h4 id="3python3">3、安装基于python3的虚拟环境</h4>
<p>虚拟环境的使用参考<a href="https://sthsf.github.io/wiki/Linux%20Tricks/virtualenv%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B.html">virtualenv使用教程</a></p>
<p>当然你也可以使用annaconda进行安装, 据说annaconda安装不会出现下面的问题.</p>
<h4 id="4-pipjupyterhub">4、配置好之后进入虚拟环境, 使用pip安装和生成jupyterhub配置文件, 同第一节中的安装方式.</h4>
<p>在执行过程中会出现下面的错误, 正确的使用方式如下:</p>
<p><strong>不使用npm安装configurable-http-proxy</strong></p>
<p>直接从源码安装nodejs,安装方法见<a href="https://github.com/nodejs/help/wiki/Installation">官网Installation</a>,我这里为了方便,直接将源码放在虚拟环境的conf文件夹下.</p>
<p>然后在<code>~/.bashrc</code>中添加环境变量</p>
<div class="hlcode"><pre><span class="n">export</span> <span class="n">NODEJS_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nodejs</span><span class="o">/</span><span class="n">node</span><span class="o">-</span><span class="n">v10</span><span class="mf">.15.0</span><span class="o">/</span><span class="n">bin</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=</span><span class="err">$</span><span class="n">NODEJS_HOME</span><span class="o">:</span><span class="err">$</span><span class="n">PATH</span>
<span class="n">export</span> <span class="n">NODEJS_HOME</span>
</pre></div>


<p>其中,<code>node-v10.15.0</code>就是自己下载的源码压缩包解压缩的内容.</p>
<p>使用源码安装配置的nodejs版本为<code>v10.15.0</code>, 官网说源码自带npm, 里面的npm版本为<code>6.6.0</code></p>
<p>所有才有前文,我的nodejs的文件目录跟默认的安装路径的区别,</p>
<p><strong><em>这时候也可以使用源码安装node后自带的npm来安装<code>configurable-http-proxy</code>, 安装好后就不需要在jupyterhub_config.py中配置了</em></strong></p>
<h4 id="5jupyterhub">5、在配置文件目录下运行jupyterhub,其他配置没有改变,结束.</h4>
<p>Docker下运行配置,与非docker下的情况类似,主要是如何访问docker下的jupyterhub,下面提供一个简单的访问使用方式<br />
- 1、设置docker容器和宿主机的端口映射,这个在运行docker的时候设置, 例如:</p>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="mi">18000</span><span class="o">:</span><span class="mi">8000</span> <span class="o">-</span><span class="n">it</span> <span class="p">[</span><span class="n">IMAGE</span> <span class="n">ID</span><span class="p">]</span>
</pre></div>


<p>因为jupyterhub启动默认使用的是8000端口,所以直接映射到container的8000端口.</p>
<p>启动之后进入container,然后只需要在jupyterhub_conf.py里面配置<code>c.Authenticator.admin_users</code>和<code>c.Authenticator.whitelist</code>即可.</p>
<p><strong><em>ps,如果是要在界面里面添加用户,只能添加ubuntu已经添加好的user</em></strong></p>
<p>然后使用<code>nohup jupyterhub &amp;</code>后台运行jupyterhub, 最后使用<code>ctrl + p + q</code>退出但是并没有关闭container. 然后就可以在其他的机器的浏览器中输入和运行<code>ip:18000</code>,输入对应的用户名和密码就可以访问jupyterhub了.</p>
<h3 id="docker">Docker镜像</h3>
<p>这里提供一个已经安装配置到的纯净<a href="https://hub.docker.com/r/liyu5257/ubuntu_jupyterhub">docker镜像地址</a>, 镜像中只包含jupyterhub.如果在安装过程中出现错误,可以pull 下来对比一下.</p>
<p><strong>错误</strong><br />
有人在使用sudo apt-get install npm nodejs-legacy的时候,安装完成后就算在jupyterhub_configure.py下配置了configurable-http-proxy的路径,或者使用<code>configurable-http-proxy -h</code>的时候会出现下面的问题,主要是nodejs安装版本可能比较低</p>
<p>使用<code>sudo apt-get install npm</code>安装完成之后,查看npm的版本<code>npm -v</code>, 版本号为<code>3.5.2</code></p>
<p>使用<code>sudo apt-get install nodejs-legacy</code>安装完成之后,查看node的版本<code>node -v</code>, 版本号为<code>v4.2.6</code></p>
<p>使用<code>npm install -g configurable-http-proxy</code> 安装会出现下面的提示</p>
<div class="hlcode"><pre><span class="o">-</span> <span class="o">|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|</span>
<span class="n">loadRequestedDeps</span>         <span class="err">\</span> <span class="o">|</span><span class="err">###############################</span><span class="o">-----------------------------------------------------------------------------------------------------------------------|</span>
<span class="nl">loadDep:</span><span class="n">winston</span> <span class="o">-&gt;</span> <span class="n">header</span> <span class="o">|</span> <span class="o">|</span><span class="err">###############################</span><span class="o">-----------------------------------------------------------------------------------------------------------------------|</span>
<span class="nl">loadDep:</span><span class="n">winston</span><span class="o">-</span><span class="n">transport</span> <span class="o">-</span> <span class="o">|</span><span class="err">####################################################</span><span class="o">--------------------------------------------------------------------------------------------------|</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">node_modules</span><span class="o">/</span><span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span>
<span class="err">`</span><span class="o">--</span> <span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="err">@</span><span class="mf">4.0.1</span>
  <span class="o">+--</span> <span class="n">commander</span><span class="err">@</span><span class="mf">2.19.0</span>
  <span class="o">+--</span> <span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="err">@</span><span class="mf">1.17.0</span>
  <span class="o">|</span> <span class="o">+--</span> <span class="n">eventemitter3</span><span class="err">@</span><span class="mf">3.1.0</span>
  <span class="o">|</span> <span class="o">+--</span> <span class="n">follow</span><span class="o">-</span><span class="n">redirects</span><span class="err">@</span><span class="mf">1.7.0</span>
  <span class="o">|</span> <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">debug</span><span class="err">@</span><span class="mf">3.2.6</span>
  <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">requires</span><span class="o">-</span><span class="n">port</span><span class="err">@</span><span class="mf">1.0.0</span>
  <span class="o">+--</span> <span class="n">lynx</span><span class="err">@</span><span class="mf">0.2.0</span>
  <span class="o">|</span> <span class="o">+--</span> <span class="n">mersenne</span><span class="err">@</span><span class="mf">0.0.4</span>
  <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">statsd</span><span class="o">-</span><span class="n">parser</span><span class="err">@</span><span class="mf">0.0.4</span>
  <span class="o">+--</span> <span class="n">strftime</span><span class="err">@</span><span class="mf">0.10.0</span>
  <span class="err">`</span><span class="o">--</span> <span class="n">winston</span><span class="err">@</span><span class="mf">3.1.0</span>
    <span class="o">+--</span> <span class="n">async</span><span class="err">@</span><span class="mf">2.6.2</span>
    <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">lodash</span><span class="err">@</span><span class="mf">4.17.11</span>
    <span class="o">+--</span> <span class="n">diagnostics</span><span class="err">@</span><span class="mf">1.1.1</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">colorspace</span><span class="err">@</span><span class="mf">1.1.1</span>
    <span class="o">|</span> <span class="o">|</span> <span class="o">+--</span> <span class="n">color</span><span class="err">@</span><span class="mf">3.0.0</span>
    <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">+--</span> <span class="n">color</span><span class="o">-</span><span class="n">convert</span><span class="err">@</span><span class="mf">1.9.3</span>
    <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">color</span><span class="o">-</span><span class="n">name</span><span class="err">@</span><span class="mf">1.1.3</span>
    <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">color</span><span class="o">-</span><span class="n">string</span><span class="err">@</span><span class="mf">1.5.3</span>
    <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>   <span class="err">`</span><span class="o">--</span> <span class="n">simple</span><span class="o">-</span><span class="n">swizzle</span><span class="err">@</span><span class="mf">0.2.2</span>
    <span class="o">|</span> <span class="o">|</span> <span class="o">|</span>     <span class="err">`</span><span class="o">--</span> <span class="n">is</span><span class="o">-</span><span class="n">arrayish</span><span class="err">@</span><span class="mf">0.3.2</span>
    <span class="o">|</span> <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">text</span><span class="o">-</span><span class="n">hex</span><span class="err">@</span><span class="mf">1.0.0</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">enabled</span><span class="err">@</span><span class="mf">1.0.2</span>
    <span class="o">|</span> <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">env</span><span class="o">-</span><span class="n">variable</span><span class="err">@</span><span class="mf">0.0.5</span>
    <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">kuler</span><span class="err">@</span><span class="mf">1.0.1</span>
    <span class="o">|</span>   <span class="err">`</span><span class="o">--</span> <span class="n">colornames</span><span class="err">@</span><span class="mf">1.1.1</span>
    <span class="o">+--</span> <span class="n">is</span><span class="o">-</span><span class="n">stream</span><span class="err">@</span><span class="mf">1.1.0</span>
    <span class="o">+--</span> <span class="n">logform</span><span class="err">@</span><span class="mf">1.10.0</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">colors</span><span class="err">@</span><span class="mf">1.3.3</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">fast</span><span class="o">-</span><span class="n">safe</span><span class="o">-</span><span class="n">stringify</span><span class="err">@</span><span class="mf">2.0.6</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">fecha</span><span class="err">@</span><span class="mf">2.3.3</span>
    <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">ms</span><span class="err">@</span><span class="mf">2.1.1</span>
    <span class="o">+--</span> <span class="n">one</span><span class="o">-</span><span class="n">time</span><span class="err">@</span><span class="mf">0.0.4</span>
    <span class="o">+--</span> <span class="n">readable</span><span class="o">-</span><span class="n">stream</span><span class="err">@</span><span class="mf">2.3.6</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">core</span><span class="o">-</span><span class="n">util</span><span class="o">-</span><span class="n">is</span><span class="err">@</span><span class="mf">1.0.2</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">inherits</span><span class="err">@</span><span class="mf">2.0.3</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">isarray</span><span class="err">@</span><span class="mf">1.0.0</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">process</span><span class="o">-</span><span class="n">nextick</span><span class="o">-</span><span class="n">args</span><span class="err">@</span><span class="mf">2.0.0</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">safe</span><span class="o">-</span><span class="n">buffer</span><span class="err">@</span><span class="mf">5.1.2</span>
    <span class="o">|</span> <span class="o">+--</span> <span class="n">string_decoder</span><span class="err">@</span><span class="mf">1.1.1</span>
    <span class="o">|</span> <span class="err">`</span><span class="o">--</span> <span class="n">util</span><span class="o">-</span><span class="n">deprecate</span><span class="err">@</span><span class="mf">1.0.2</span>
    <span class="o">+--</span> <span class="n">stack</span><span class="o">-</span><span class="n">trace</span><span class="err">@</span><span class="mf">0.0.10</span>
    <span class="o">+--</span> <span class="n">triple</span><span class="o">-</span><span class="n">beam</span><span class="err">@</span><span class="mf">1.3.0</span>
    <span class="err">`</span><span class="o">--</span> <span class="n">winston</span><span class="o">-</span><span class="n">transport</span><span class="err">@</span><span class="mf">4.3.0</span>
</pre></div>


<p>configurable-http-proxy的整个安装过程没有错误提示, 但是使用<code>configurable-http-proxy -h</code>检查的时候出现下面的错误:</p>
<div class="hlcode"><pre><span class="p">/</span><span class="nx">usr</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">node_modules</span><span class="p">/</span><span class="nx">configurable</span><span class="na">-http-proxy</span><span class="p">/</span><span class="nx">node_modules</span><span class="p">/</span><span class="nx">winston</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">winston.js</span><span class="p">:</span><span class="mi">11</span>
<span class="nx">const</span> <span class="p">{</span> <span class="nx">warn</span> <span class="p">}</span> <span class="o">=</span> <span class="k">require</span><span class="err">(&#39;.</span><span class="n">/</span><span class="nx">winston</span><span class="p">/</span><span class="nx">common</span><span class="s1">&#39;);</span>
<span class="s1">      ^</span>

<span class="s1">SyntaxError: Unexpected token {</span>
<span class="s1">    at exports.runInThisContext (vm.js:53:16)</span>
<span class="s1">    at Module._compile (module.js:374:25)</span>
<span class="s1">    at Object.Module._extensions..js (module.js:417:10)</span>
<span class="s1">    at Module.load (module.js:344:32)</span>
<span class="s1">    at Function.Module._load (module.js:301:12)</span>
<span class="s1">    at Module.require (module.js:354:17)</span>
<span class="s1">    at require (internal/module.js:12:17)</span>
<span class="s1">    at Object.&lt;anonymous&gt; (/usr/local/lib/node_modules/configurable-http-proxy/bin/configurable-http-proxy:14:13)</span>
<span class="s1">    at Module._compile (module.js:410:26)</span>
<span class="s1">    at Object.Module._extensions..js (module.js:417:10)</span>
</pre></div>


<p>上面的安装步骤都是正确的,而且没有报错,官网github的<strong><a href="https://github.com/jupyterhub/jupyterhub/issues/2332">issue</a></strong>中有关于上面类似的问题,里面有人提到可能是npm的版本过低或者不对应等问题,于是到node的官网查看node的发行版本,发现node的版本都已经V10以上了,而本地npm安装的版本才4.推测可能是版本太低,不兼容所致.</p>
<p>于是尝试升级npm,node,结果使用<code>npm install npm -g</code>依然无法升级到最新的版本.最终的解决方法是直接从官网把源码下下来,然后配置一下环境变量,具体参见前面的操作步骤</p>
<p>后面,上面的的问题通过更新的方法没有解决有点不甘心,然后又使用<code>whereis nodejs</code>将安装路径找出来.</p>
<div class="hlcode"><pre><span class="nl">nodejs:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">nodejs</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">nodejs</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">nodejs</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nodejs</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">man</span><span class="o">/</span><span class="n">man1</span><span class="o">/</span><span class="n">nodejs</span><span class="mf">.1</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>然后找到<code>configurable-http-proxy</code>的安装目录<code>/usr/local/lib/node_modules/configurable-http-proxy</code>,将它添加到jupyterhub_config.py中,然后运行jupyterhub.</p>
<p>之前的错误提示没了,但是后面又出现了下面的问题:</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">I</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">07</span> <span class="mi">14</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mf">04.979</span> <span class="n">JupyterHub</span> <span class="n">proxy</span><span class="o">:</span><span class="mi">567</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">proxy</span> <span class="err">@</span> <span class="n">http</span><span class="o">:</span><span class="c1">//:8000</span>
<span class="p">[</span><span class="n">C</span> <span class="mi">2019</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">07</span> <span class="mi">14</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mf">04.980</span> <span class="n">JupyterHub</span> <span class="n">app</span><span class="o">:</span><span class="mi">1867</span><span class="p">]</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">start</span> <span class="n">proxy</span>
    <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span><span class="o">:</span>
      <span class="n">File</span> <span class="s">&quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/app.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1865</span><span class="p">,</span> <span class="n">in</span> <span class="n">start</span>
        <span class="n">await</span> <span class="n">self</span><span class="p">.</span><span class="n">proxy</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
      <span class="n">File</span> <span class="s">&quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/proxy.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">571</span><span class="p">,</span> <span class="n">in</span> <span class="n">start</span>
        <span class="n">self</span><span class="p">.</span><span class="n">proxy_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">start_new_session</span><span class="o">=</span><span class="n">True</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">)</span>
      <span class="n">File</span> <span class="s">&quot;/usr/lib/python3.6/subprocess.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">709</span><span class="p">,</span> <span class="n">in</span> <span class="n">__init__</span>
        <span class="n">restore_signals</span><span class="p">,</span> <span class="n">start_new_session</span><span class="p">)</span>
      <span class="n">File</span> <span class="s">&quot;/usr/lib/python3.6/subprocess.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1344</span><span class="p">,</span> <span class="n">in</span> <span class="n">_execute_child</span>
        <span class="n">raise</span> <span class="n">child_exception_type</span><span class="p">(</span><span class="n">errno_num</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">,</span> <span class="n">err_filename</span><span class="p">)</span>
    <span class="nl">PermissionError:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">13</span><span class="p">]</span> <span class="n">Permission</span> <span class="n">denied</span><span class="o">:</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">node_modules</span><span class="o">/</span><span class="n">configurable</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">proxy</span><span class="err">&#39;</span>
</pre></div>


<p>权限问题,一脸懵,所有的操作都是root用户,又去查看了node_modules这个文件,发现用户名是nobody,又是一脸懵.算了,使用777修改文件夹的权限.修改完之后重新运行jupyterhu还是同样的问题,这个问题就没有解决了,最后还是使用上面的的教程,从官网下载nodejs替换之后两个问题都没有出现,jupyterhub可以在docker上启动,其他配置需要自己配置.</p>
<p><strong>ps</strong>,之前学习使用nodejs的时候刚开始也是使用npm来做程序管理的, 但是是由于npm一直无法更新到最新, 后来才从源码安装的.</p>
<p><strong>ps</strong>网上说npm的镜像在国外, 也有可能自己在使用npm升级的时候没有升级成功, 导致一系列的错误, 但是升级不成功他也不能没有提示吧. 有空可以设置使用淘宝镜像然后再尝试尝试.</p>
<h1 id="jupyterhubtensorflow-gpu">jupyterhub下使用tensorflow-gpu产生的错误</h1>
<p>[update2019-09-19]使用jupyter的过程出现了一个奇怪的问题, 在终端下测试使用tensorflow调用gpu的情况没有问题, 但是在jupyter使用同样的代码则检测不到gpu</p>
<p>具体检测代码如下:</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">client</span> <span class="n">import</span> <span class="n">device_lib</span>
<span class="n">print</span><span class="p">(</span><span class="n">device_lib</span><span class="p">.</span><span class="n">list_local_devices</span><span class="p">())</span>  <span class="err">#</span> <span class="err">打印可用的</span><span class="n">device</span><span class="p">,</span> <span class="err">包括</span><span class="n">cpu</span><span class="err">和</span><span class="n">gpu</span>
</pre></div>


<p>输出结果:</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:CPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;CPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">268435456</span>
<span class="n">locality</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">15259160786169634382</span>
<span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:XLA_GPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;XLA_GPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">17179869184</span>
<span class="n">locality</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">8968781236993845730</span>
<span class="nl">physical_device_desc:</span> <span class="s">&quot;device: XLA_GPU device&quot;</span>
<span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:XLA_CPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;XLA_CPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">17179869184</span>
<span class="n">locality</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">9349831921872187387</span>
<span class="nl">physical_device_desc:</span> <span class="s">&quot;device: XLA_CPU device&quot;</span>
<span class="p">]</span>
</pre></div>


<p>终端下调用执行上面的代码:</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:CPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;CPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">268435456</span>
<span class="n">locality</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">8983197487004247094</span>
<span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:XLA_GPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;XLA_GPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">17179869184</span>
<span class="n">locality</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">17880524038454437849</span>
<span class="nl">physical_device_desc:</span> <span class="s">&quot;device: XLA_GPU device&quot;</span>
<span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:XLA_CPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;XLA_CPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">17179869184</span>
<span class="n">locality</span> <span class="p">{</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">6972433931048861409</span>
<span class="nl">physical_device_desc:</span> <span class="s">&quot;device: XLA_CPU device&quot;</span>
<span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="s">&quot;/device:GPU:0&quot;</span>
<span class="nl">device_type:</span> <span class="s">&quot;GPU&quot;</span>
<span class="nl">memory_limit:</span> <span class="mi">7967745639</span>
<span class="n">locality</span> <span class="p">{</span>
  <span class="nl">bus_id:</span> <span class="mi">1</span>
  <span class="n">links</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nl">incarnation:</span> <span class="mi">11302034368239340091</span>
<span class="nl">physical_device_desc:</span> <span class="s">&quot;device: 0, name: GeForce GTX 1080, pci bus id: 0000:01:00.0, compute capability: 6.1&quot;</span>
<span class="p">]</span>
</pre></div>


<p>对比中断和jupyterhub下的输出结果, 会发现jupyterhub下缺了GPU信息, 然后在程序用调用gpu则会报错:</p>
<p>调用程序如下:</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">tensorflow</span> <span class="n">as</span> <span class="n">tf</span>

<span class="n">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">cpu</span><span class="o">:</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">)</span><span class="o">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="sc">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="sc">&#39;b&#39;</span><span class="p">)</span>
<span class="n">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">gpu</span><span class="o">:</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">)</span><span class="o">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">ConfigProto</span><span class="p">(</span><span class="n">log_device_placement</span><span class="o">=</span><span class="n">True</span><span class="p">))</span>
<span class="n">sess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
<span class="n">print</span><span class="p">(</span><span class="n">sess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</pre></div>


<p>部分报错信息如下:</p>
<div class="hlcode"><pre><span class="n">InvalidArgumentError</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">assign</span> <span class="n">a</span> <span class="n">device</span> <span class="k">for</span> <span class="n">operation</span> <span class="n">MatMul</span><span class="o">:</span> <span class="n">node</span> <span class="n">MatMul</span> <span class="o">(</span><span class="n">defined</span> <span class="n">at</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="n">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">4</span><span class="n">db82431c7bb</span><span class="o">&gt;:</span><span class="mi">7</span><span class="o">)</span> <span class="n">was</span> <span class="n">explicitly</span> <span class="n">assigned</span> <span class="n">to</span> <span class="sr">/device:GPU:0 but available devices are [ /job:localhost/replica:0/task:0/device:CPU:0, /job:localhost/replica:0/task:0/device:XLA_CPU:0, /job:localhost/replica:0/task:0/</span><span class="n">device</span><span class="o">:</span><span class="n">XLA_GPU</span><span class="o">:</span><span class="mi">0</span> <span class="o">].</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">device</span> <span class="n">specification</span> <span class="n">refers</span> <span class="n">to</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">device</span><span class="o">.</span>
     <span class="o">[[</span><span class="n">MatMul</span><span class="o">]]</span>

<span class="n">Errors</span> <span class="n">may</span> <span class="n">have</span> <span class="n">originated</span> <span class="n">from</span> <span class="n">an</span> <span class="n">input</span> <span class="n">operation</span><span class="o">.</span>
<span class="n">Input</span> <span class="n">Source</span> <span class="n">operations</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">node</span> <span class="n">MatMul</span><span class="o">:</span>
 <span class="n">b</span> <span class="o">(</span><span class="n">defined</span> <span class="n">at</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="n">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">4</span><span class="n">db82431c7bb</span><span class="o">&gt;:</span><span class="mi">5</span><span class="o">)</span>    
 <span class="n">a</span> <span class="o">(</span><span class="n">defined</span> <span class="n">at</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="n">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">4</span><span class="n">db82431c7bb</span><span class="o">&gt;:</span><span class="mi">4</span><span class="o">)</span>
</pre></div>


<p>然后在后台的jupyterhub后台输出的日志中的报错结果如下, 但同样的程序在终端下执行缺不会出问题.</p>
<div class="hlcode"><pre><span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">19</span> <span class="mi">17</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">38.137139</span><span class="p">:</span> <span class="nx">I</span> <span class="nx">tensorflow</span><span class="p">/</span><span class="nx">core</span><span class="p">/</span><span class="nx">platform</span><span class="p">/</span><span class="nx">profile_utils</span><span class="p">/</span><span class="nx">cpu_utils.cc</span><span class="p">:</span><span class="mi">94</span><span class="cp">]</span> CPU Frequency: 3600000000 Hz
2019-09-19 17:15:38.137612: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x4ea6990 executing computations on platform Host. Devices:
2019-09-19 17:15:38.137626: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): <span class="nt">&lt;undefined&gt;</span>, <span class="nt">&lt;undefined&gt;</span>
2019-09-19 17:15:38.137759: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:1005] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2019-09-19 17:15:38.138151: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1640] Found device 0 with properties:
name: GeForce GTX 1080 major: 6 minor: 1 memoryClockRate(GHz): 1.7335
pciBusID: 0000:01:00.0
2019-09-19 17:15:38.138236: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Could not dlopen library &#39;libcudart.so.10.0&#39;; dlerror: libcudart.so.10.0: cannot open shared object file: No such file or directory
2019-09-19 17:15:38.138289: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Could not dlopen library &#39;libcublas.so.10.0&#39;; dlerror: libcublas.so.10.0: cannot open shared object file: No such file or directory
2019-09-19 17:15:38.138336: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Could not dlopen library &#39;libcufft.so.10.0&#39;; dlerror: libcufft.so.10.0: cannot open shared object file: No such file or directory
2019-09-19 17:15:38.138384: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Could not dlopen library &#39;libcurand.so.10.0&#39;; dlerror: libcurand.so.10.0: cannot open shared object file: No such file or directory
2019-09-19 17:15:38.138424: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Could not dlopen library &#39;libcusolver.so.10.0&#39;; dlerror: libcusolver.so.10.0: cannot open shared object file: No such file or directory
2019-09-19 17:15:38.138467: I tensorflow/stream_executor/platform/default/dso_loader.cc:53] Could not dlopen library &#39;libcusparse.so.10.0&#39;; dlerror: libcusparse.so.10.0: cannot open shared object file: No such file or directory
2019-09-19 17:15:38.140342: I tensorflow/stream_executor/platform/default/dso_loader.cc:42] Successfully opened dynamic library libcudnn.so.7
2019-09-19 17:15:38.140355: W tensorflow/core/common_runtime/gpu/gpu_device.cc:1663] Cannot dlopen some GPU libraries. Skipping registering GPU devices...
2019-09-19 17:15:38.140367: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1181] Device interconnect StreamExecutor with strength 1 edge matrix:
2019-09-19 17:15:38.140373: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1187]      0
2019-09-19 17:15:38.140377: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1200] 0:   N
<span class="cp">[</span><span class="nx">I</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">19</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">29.796</span> <span class="nx">SingleUserNotebookApp</span> <span class="k">log</span><span class="p">:</span><span class="mi">158</span><span class="cp">]</span> 200 GET /user/jerry/api/contents/jerry/workshop/projects/jupyter_projects/Untitled.ipynb?content=0<span class="err">&amp;</span>_=1568884528992 (jerry@10.15.176.199) 3.05ms
<span class="cp">[</span><span class="nx">I</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">19</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">29.821</span> <span class="nx">SingleUserNotebookApp</span> <span class="nx">handlers</span><span class="p">:</span><span class="mi">164</span><span class="cp">]</span> Saving file at /jerry/workshop/projects/jupyter_projects/Untitled.ipynb
<span class="cp">[</span><span class="nx">I</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">19</span> <span class="mi">17</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">29.986</span> <span class="nx">SingleUserNotebookApp</span> <span class="k">log</span><span class="p">:</span><span class="mi">158</span><span class="cp">]</span> 200 PUT /user/jerry/api/contents/jerry/workshop/projects/jupyter_projects/Untitled.ipynb (jerry@10.15.176.199) 169.95ms
</pre></div>


<p>查阅相关文档, 需要对jupyterhub做如下设置, 在jupyterhub的配置文件中添加下面一行:</p>
<div class="hlcode"><pre><span class="n">c</span><span class="p">.</span><span class="n">Spawner</span><span class="p">.</span><span class="n">env_keep</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="n">LD_LIBRARY_PATH</span><span class="err">&#39;</span><span class="p">)</span>   <span class="err">#</span> <span class="err">这行是我们踩的坑，因为用了</span><span class="n">GPU</span><span class="err">版的</span><span class="n">tensorflow</span><span class="err">，这个目的是将</span><span class="n">LD_LIBRARY_PATH</span><span class="err">的路径放到</span><span class="n">jupyterhub</span><span class="err">中，这样才能正确使用</span><span class="n">GPU</span><span class="err">版的</span><span class="n">tensorflow</span><span class="err">。</span>
</pre></div>


<p>重启之后, 运行上面的两段代码, 没有报错, 然后跟终端下运行的结果一致.</p>
<p>另外, 有同事在jupyter下运行也出现同样的问题, 不过他的解决方案是不在root下启动, 或者不使用sudo启动jupyter.</p>
<h1 id="_3">参考文献</h1>
<p><a href="https://blog.csdn.net/qq_16094777/article/details/78771716">jupyterhub完整安装和配置gitlab账号认证</a></p>
<p><a href="https://www.jianshu.com/p/fd9ddce53465">搭建一套云工作平台 (JupyterHub + Rstudio Server)</a></p>
<p><a href="https://my.oschina.net/u/2306127/blog/1837196">JupyterHub on Kubernetes部署与应用指南</a></p>
<p><a href="https://www.liangzl.com/get-article-detail-16066.html">为JupyterHub自定义Notebook Images</a></p>
<p><a href="https://blog.csdn.net/vah101/article/details/79793006">JupyterHub + toree安装说明</a></p>
<p><a href="https://blog.csdn.net/Fire_to_cheat_/article/details/84938975">jupyter notebook安装插件，代码补全</a></p>
<p><a href="https://jupyterhub.readthedocs.io/en/latest/index.html">JupyterHub</a></p>
<p><a href="https://blog.51cto.com/m51cto/2370679">Jupyterhub安装配置及心得</a></p>
<p><a href="https://hub.docker.com/r/jupyterhub/jupyterhub/">Docker JupyterHub</a></p>
<p><a href="https://www.cnblogs.com/bregman/p/5744109.html">jupyterhub 安装配置</a></p>
<p><a href="https://zero-to-jupyterhub.readthedocs.io/en/latest/">Zero to JupyterHub with Kubernetes</a></p>
<p><a href="https://www.jianshu.com/p/0285feaa2ba2">在AWS上配置jupyterhub</a></p>
<p><a href="https://blog.csdn.net/luoluonuoyasuolong/article/details/88526526">jupyterhub 安装教程</a></p>
</div>
<div id="content-footer">created in <span class="create-date date"> 2019-03-02 00:00 </span></div>
<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  title: 'JupyterHub 部署与应用指南',
  owner: 'sthsf',
  repo: 'wiki',
  oauth: {
    client_id: '086c54c5fd95adfdc372',
    client_secret: '2ad9ebe87b952d2c77fccf99c334881b91eaa73d',
  },
  // ...
  // For more available options, check out the documentation below
})
gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

</div>
<div id="footer">
            <span>
                Copyright © 2020 LiYu.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Fork me in <a href="https://github.com/sthsf/wiki" target="_blank"> github </a>.
            </span>
</div>


<!--百度统计-->
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?90e1dcdd1938573c19f9ff6521188e91";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


</body>
</html>