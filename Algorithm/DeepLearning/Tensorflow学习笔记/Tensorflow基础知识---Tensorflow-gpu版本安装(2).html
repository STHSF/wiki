<!DOCTYPE HTML>
<html>
<head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <title>Tensorflow基础知识---Ubuntu16.04下安装安装CUDA9.0、cuDNN7.0和tensotflow-gpu 1.8.0以上的版本流程和问题总结 - LiYu's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Economics"/>
    <meta name="description" content="A wiki website of sthsf when I learned new knowledgy and technics."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width" />

    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
        });
        </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-78529611-1', 'auto');
        ga('send', 'pageview');

    </script>
</head>

<body>
<div id="container">
    
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#Algorithm">Algorithm</a>&nbsp;»&nbsp;<a href="/wiki/#Algorithm-DeepLearning">DeepLearning</a>&nbsp;»&nbsp;<a href="/wiki/#Algorithm-DeepLearning-Tensorflow学习笔记">Tensorflow学习笔记</a>&nbsp;»&nbsp;Tensorflow基础知识---Ubuntu16.04下安装安装CUDA9.0、cuDNN7.0和tensotflow-gpu 1.8.0以上的版本流程和问题总结</div>
</div>
<div class="clearfix"></div>
<div id="title">Tensorflow基础知识---Ubuntu16.04下安装安装CUDA9.0、cuDNN7.0和tensotflow-gpu 1.8.0以上的版本流程和问题总结</div>
<div id="content">
  <h1 id="_1">写在前面</h1>
<p>Tensorflow版本更新太快了，最新版已经更新到1.8.0了，Tensorflow在1.7的时候就已经对cuda和cudnn的版本有所要求，所以下面介绍安装cuda9.0和cudnn9.0的安装。台式机的配置如下：</p>
<div class="hlcode"><pre><span class="n">System</span><span class="err">：</span><span class="n">Ubuntu</span> <span class="mf">16.04</span> <span class="n">LTS</span>
<span class="nl">CPU:</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Core</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">i7</span><span class="o">-</span><span class="mi">7700</span> <span class="n">CPU</span> <span class="err">@</span> <span class="mf">3.60</span><span class="n">GHz</span>
<span class="nl">MemTotal:</span> <span class="mi">16295024</span> <span class="n">kB</span>
<span class="nl">GPU:</span> <span class="n">GeForce</span> <span class="n">GTX</span> <span class="mi">1080</span>
</pre></div>


<h1 id="n">一、N卡驱动安装</h1>
<h2 id="nvidia">Nvidia官网下载对应显卡驱动安装</h2>
<h3 id="1">1、驱动下载</h3>
<p>去<a href="http://www.nvidia.cn/Download/index.aspx?lang=cn">nvidia官网</a>下载对应的驱动，根据自己的显卡型号和操作系统手动查找对应的驱动文件，我的显卡型号是GTX1080，所以下载的驱动文件名为<strong>NVIDIA-Linux-x86_64-390.48.run</strong>。如下图所示。<br />
<center><img src="/wiki/static/images/tensorgpu/nvidia_driver.jpg" alt="nvidia-driver"/></center></p>
<h3 id="2n">2、先卸载原有N卡驱动</h3>
<div class="hlcode"><pre><span class="cp">#for case1: original driver installed by apt-get:</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="o">--</span><span class="n">purge</span> <span class="n">nvidia</span><span class="o">*</span>

<span class="cp">#for case2: original driver installed by runfile:</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">*</span><span class="p">.</span><span class="n">run</span>
<span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">NVIDIA</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="mf">384.59</span><span class="p">.</span><span class="n">run</span> <span class="o">--</span><span class="n">uninstall</span>
</pre></div>


<p>如果原驱动是用apt-get安装的，就用第1种方法卸载。 <br />
如果原驱动是用runfile安装的，就用–uninstall命令卸载。其实，用runfile安装的时候也会卸载掉之前的驱动，所以不手动卸载亦可。</p>
<h3 id="3nouveau">3、禁用nouveau驱动</h3>
<p>创建或更新blacklist-nouveau.conf，有的教程中会更新blacklist.conf</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">modprobe</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">blacklist</span><span class="o">-</span><span class="n">nouveau</span><span class="p">.</span><span class="n">conf</span>
<span class="n">or</span>
<span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">modprobe</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">blacklist</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>在文本最后添加：（禁用nouveau第三方驱动，之后也不需要改回来）</p>
<div class="hlcode"><pre><span class="n">blacklist</span> <span class="n">nouveau</span>
<span class="n">options</span> <span class="n">nouveau</span> <span class="n">modeset</span><span class="o">=</span><span class="mi">0</span>
</pre></div>


<p>然后执行：<code>sudo update-initramfs -u</code>, 重新生成 kernel initramfs</p>
<p>重启后，执行：lsmod | grep nouveau。如果没有屏幕输出，说明禁用nouveau成功。</p>
<h3 id="4x-window">4、禁用X-Window服务</h3>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">service</span> <span class="n">lightdm</span> <span class="n">stop</span> <span class="err">#这会关闭图形界面，但不用紧张</span>
</pre></div>


<p>按Ctrl-Alt+F1进入命令行界面，输入用户名和密码登录即可。</p>
<p><strong>小提示</strong>：在命令行输入：sudo service lightdm start ，然后按Ctrl-Alt+F7即可恢复到图形界面。</p>
<h3 id="5">5、命令行安装驱动</h3>
<div class="hlcode"><pre><span class="cp">#给驱动run文件赋予执行权限：</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">NVIDIA</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="mf">390.48</span><span class="p">.</span><span class="n">run</span>
<span class="cp">#后面的参数非常重要，不可省略：</span>
<span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">NVIDIA</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="mf">390.48</span><span class="p">.</span><span class="n">run</span> <span class="err">–</span><span class="n">no</span><span class="o">-</span><span class="n">opengl</span><span class="o">-</span><span class="n">files</span>
</pre></div>


<ul>
<li>–no-x-check：表示安装驱动时不检查X服务，非必需。</li>
<li>–no-nouveau-check：表示安装驱动时不检查nouveau，非必需。</li>
<li>-Z, --disable-nouveau：禁用nouveau。此参数非必需，因为之前已经手动禁用了nouveau。</li>
<li>-A：查看更多高级选项。</li>
</ul>
<p>必选参数解释：因为NVIDIA的驱动默认会安装OpenGL，而Ubuntu的内核本身也有OpenGL、且与GUI显示息息相关，一旦NVIDIA的驱动覆写了OpenGL，在GUI需要动态链接OpenGL库的时候就引起问题。之后，按照提示安装，成功后重启即可。 <br />
如果提示安装失败，不要急着重启电脑，重复以上步骤，多安装几次即可。</p>
<p><strong>PS: Ubuntu系统会自动更新linux内核，服务器重启之后会出现nvidia Driver找不到的情况，重新安装驱动之后问题解决。所以建议关闭Linux内核自动更新。</strong><br />
<strong>UPDATE 20190510</strong>ubuntu系统更新或者软件更新后,可能可能nvidia驱动会丢失,[使用Nvidia-smi显示不了显卡信息] ,我在碰到这个问题之后,直接是选择将显卡驱动重装一遍, 按照上面的方式重装之后显卡信息就可以显示了.驱动重装之后最好也在检查一下cuda和cudnn有没有问题.</p>
<h3 id="6driver">6、Driver测试：</h3>
<div class="hlcode"><pre><span class="n">nvidia</span><span class="o">-</span><span class="n">smi</span> <span class="err">#</span> <span class="err">若列出</span><span class="n">GPU</span><span class="err">的信息列表，表示驱动安装成功</span>
<span class="n">nvidia</span><span class="o">-</span><span class="n">settings</span> <span class="err">#</span> <span class="err">若弹出设置对话框，亦表示驱动安装成功</span><span class="p">(</span><span class="err">该命令只能在</span><span class="n">GUI</span><span class="err">下才能使用，关闭图形界面是无法弹出什么对话框的</span><span class="p">)</span>
</pre></div>


<h1 id="cuda">二、安装cuda</h1>
<h2 id="1nouveau-nvidia">1、检查自带的nouveau nvidia驱动是否禁用。</h2>
<p>如果安装cuda和安装显卡驱动没有同时进行，则需要检查这一步，同样安装cuda和显卡驱动都需要禁用nouveau驱动。</p>
<h2 id="2ctrl-alt-f1">2、<code>Ctrl + Alt + F1</code> 进入命令行模式，执行，</h2>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">sudo</span> <span class="n">service</span> <span class="n">lightdm</span> <span class="n">stop</span>      <span class="c1">// 关闭桌面服务</span>
</pre></div>


<p>在安装CUDA的过程中必须得关闭桌面服务。</p>
<p>当然，你也可以在终端中执行关闭桌面服务操作，然后使用 <code>Ctrl + Alt + F1</code> 登陆你的账号。我在安装的过程中是先关闭桌面服务然后使用<code>Ctrl + Alt + F1</code>进入终端然后重新登陆账号密码的。</p>
<p><strong>注，在安装nvidia显卡驱动和cuda的时候都需要关闭桌面服务，或者可以在安装完显卡驱动之后不恢复图形界面，直接安装cuda。</strong></p>
<h2 id="3cudarun">3、安装CUDA.run文件</h2>
<p>我安装的是CUDA9.0的版本，到<a href="https://developer.nvidia.com/cuda-downloads?target_os=Linux&amp;target_arch=x86_64&amp;target_distro=Ubuntu&amp;target_version=1604&amp;target_type=runfilelocal">nvidia开发者社区</a>根据选项挑选对应的安装版本，如下图所示。<br />
<center><img src="/wiki/static/images/tensorgpu/CUDA Toolkit 9.0 Downloads.png" alt="nvidia-driver"/></center><br />
本文下载的cuda.run文件版本为: <strong>cuda_9.0.176_384.81_linux.run</strong></p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">sh</span> <span class="n">cuda_9</span><span class="mf">.0.176</span><span class="n">_384</span><span class="mf">.81</span><span class="n">_linux</span><span class="p">.</span><span class="n">run</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">opengl</span><span class="o">-</span><span class="n">libs</span>
</pre></div>


<p>在.run文件后面添加--no-opengl-libs的详解见<a href="https://www.cnblogs.com/gaowengang/p/6068788.html">Ubuntu 14.04 安装 CUDA 问题及解决</a>，安装完成后需要将opengl的相关lib重新安装一下。</p>
<p>运行之后会跳出readme文件，然后按住<code>Ctrl + C</code>跳过。然后会依次出现以下提示：</p>
<div class="hlcode"><pre><span class="n">Do</span> <span class="n">you</span> <span class="n">accept</span> <span class="n">the</span> <span class="n">previously</span> <span class="n">read</span> <span class="n">EULA</span><span class="err">，</span>  <span class="err">输入</span> <span class="n">accept</span><span class="err">，进入下一步。</span>
<span class="n">INSTALL</span> <span class="n">NVIDIA</span> <span class="n">Accelerates</span> <span class="n">Graphics</span> <span class="n">Driver</span> <span class="k">for</span> <span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span> <span class="mf">375.26</span><span class="err">，</span>  <span class="err">输入</span><span class="n">n</span><span class="err">，进入下一步；</span>
<span class="n">Install</span> <span class="n">the</span>  <span class="n">CUDA</span> <span class="mf">9.0</span> <span class="n">Toolkit</span><span class="o">?</span><span class="err">，</span>  <span class="err">输入</span><span class="n">y</span><span class="err">，</span> <span class="err">进入下一步；</span>
<span class="n">Enter</span> <span class="n">Tookit</span> <span class="n">Location</span> <span class="err">点击</span><span class="n">enter</span><span class="err">，</span> <span class="err">进入下一步；</span>
<span class="n">Do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">install</span> <span class="n">a</span> <span class="n">symbolic</span> <span class="n">link</span> <span class="n">at</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="err">，</span>  <span class="err">输入</span><span class="n">y</span><span class="err">，进入下一步；</span>
<span class="n">Install</span> <span class="n">the</span> <span class="n">CUDA</span> <span class="mf">9.0</span> <span class="n">Samples</span><span class="o">?</span>  <span class="err">输入</span><span class="n">y</span><span class="err">，</span> <span class="err">进入下一步；</span>
<span class="n">Enter</span> <span class="n">CUDA</span> <span class="n">Samples</span> <span class="n">Location</span> <span class="err">点击</span><span class="n">enter</span><span class="err">，</span> <span class="err">进入下一步；</span>
<span class="err">程序开始安装。。。</span>
</pre></div>


<p>更详细的提示见<a href="https://segmentfault.com/a/1190000008234390">Ubuntu16.04 下安装GPU版TensorFlow（包括Cuda和Cudnn）</a></p>
<p>安装完成之后，会提示一个summary；大致内容如下。</p>
<div class="hlcode"><pre><span class="n">Driver</span><span class="o">:</span> <span class="n">Not</span> <span class="n">Selectd</span>
<span class="n">Toolkit</span><span class="o">:</span> <span class="n">INstalled</span> <span class="k">in</span> <span class="sr">/usr/local/</span><span class="n">cuda</span><span class="o">-</span><span class="mf">9.0</span>
<span class="n">Samples</span><span class="o">:</span> <span class="n">Installed</span> <span class="k">in</span> <span class="sr">/home/</span><span class="n">jerry</span><span class="o">,</span> <span class="n">but</span> <span class="n">missing</span> <span class="n">recommended</span> <span class="n">libraries</span>
</pre></div>


<p><strong><em>注意</em></strong><br />
这时候会有一个提示，类似于下图，fail的原因是CUDA Driver没有安装。也有人说是因为双显卡(独立显卡和集成显卡)的原因。<br />
<center><img src="/wiki/static/images/tensorgpu/devicequeryerror.png" alt="devicequeryerror"/></center><br />
程序下面又一个warning：</p>
<div class="hlcode"><pre><span class="o">***</span><span class="nx">WARNING</span><span class="p">:</span> <span class="nx">Incomplete</span> <span class="nx">installation</span><span class="o">!</span> <span class="nx">This</span> <span class="nx">installation</span> <span class="nx">did</span> <span class="ow">not</span> <span class="nb">install</span> <span class="nx">the</span> <span class="nx">CUDA</span> <span class="nx">Driver.</span> <span class="nx">A</span> <span class="nx">driver</span> <span class="nx">of</span> <span class="nb">version</span> <span class="nx">at</span> <span class="nx">least</span> <span class="mf">361.00</span> <span class="nx">is</span> <span class="nx">required</span> <span class="nb">for</span> <span class="nx">CUDA</span> <span class="mf">8.0</span> <span class="nx">functionality</span> <span class="k">to</span> <span class="nx">work.</span>
<span class="k">To</span> <span class="nb">install</span> <span class="nx">the</span> <span class="nx">driver</span> <span class="nx">using</span> <span class="nx">this</span> <span class="nx">installer</span><span class="p">,</span> <span class="nb">run</span> <span class="nx">the</span> <span class="nx">following</span> <span class="nb">command</span><span class="p">,</span> <span class="nx">replacing</span> <span class="o">&lt;</span><span class="nx">CudaInstaller</span><span class="o">&gt;</span> <span class="k">with</span> <span class="nx">the</span> <span class="nb">name</span> <span class="nx">of</span> <span class="nx">this</span> <span class="nb">run</span> <span class="nb">file</span><span class="p">:</span>
    <span class="nx">sudo</span> <span class="o">&lt;</span><span class="nx">CudaInstaller</span><span class="o">&gt;</span><span class="bp">.</span><span class="nb">run</span> <span class="na">-silent</span> <span class="na">-driver</span>
</pre></div>


<p>根据warning提示，在.run文件后面添加-silent -driver，有提示的图片忘记保存了。以后遇到在加上。</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">sh</span> <span class="n">cuda_9</span><span class="mf">.0.176</span><span class="n">_384</span><span class="mf">.81</span><span class="n">_linux</span><span class="p">.</span><span class="n">run</span> <span class="o">-</span><span class="n">silent</span> <span class="o">-</span><span class="n">driver</span>
</pre></div>


<p>安装完成之后，启动桌面</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">sudo</span> <span class="n">service</span> <span class="n">lightdm</span> <span class="n">start</span>     <span class="c1">// 重启桌面服务</span>
</pre></div>


<p>为了检查安装是否正确，从cuda的samples中选择样例进行测试。</p>
<div class="hlcode"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">-</span><span class="mf">9.0</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="mi">1</span><span class="n">_Utilities</span><span class="o">/</span><span class="n">deviceQuery</span>
<span class="n">sudo</span> <span class="n">make</span> <span class="n">clean</span> <span class="o">&amp;&amp;</span> <span class="n">make</span>
<span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">deviceQuery</span>
</pre></div>


<p><strong>注意，我在升级tensorflow至1.7后，此时cuda需要升级到cuda9.0,在安装cuda9.0的过程中，Driver显示的是Not Selectd，但是使用<code>sudo &lt;CudaInstaller&gt;.run -silent -driver</code>的方式并没有能够安装成功。但是我在使用samples中的样例测试也是可以的，没有出问题。所以这边Driver有没有select好像没有什么区别。对后面安装cudnn和tensorflow-gpu都没有什么影响。后面没有出现问题，所以也就没有去解决。(更新时间4月18日)</strong></p>
<p><strong>附</strong><a href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html">CUDA官方安装教程</a></p>
<p>如果显示的是一些关于GPU的信息，则说明安装成功了，详细信息见下图。<br />
<center><img src="/wiki/static/images/tensorgpu/devicequery9.0.png" alt="devicequery"/></center></p>
<h2 id="cuda_1">CUDA配置环境变量</h2>
<p>在CUDA安装完成之后，log日志中有提示需要声明环境变量，不然后面安装cudnn时会出现找不到.so文件。所以需要在/etc/profile(<em>最好在~/.bashrc中添加</em>)中添加下面的内容。</p>
<div class="hlcode"><pre><span class="n">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">bin</span><span class="o">:</span><span class="err">$</span><span class="n">PATH</span>
<span class="n">export</span> <span class="n">PATH</span>
<span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="err">$</span><span class="n">LD_LIBRARY_PATH</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span>
<span class="n">export</span> <span class="n">LD_LIBRARY_PATH</span>
</pre></div>


<p>最后<code>source /etc/profile</code>即可。</p>
<h1 id="cudnn">三、安装cudnn</h1>
<h2 id="1cudnn">1、cudnn 下载</h2>
<p>cudnn的下载需要注册之后才能下载。<a href="https://developer.nvidia.com/rdp/cudnn-archive">官网下载地址</a></p>
<p>在CUDA安装好之后，CUDNN安装相对比较容易，根据官网教程，首先从官网上下载四个文件。如下图所示：<br />
<center><img src="/wiki/static/images/tensorgpu/cudnndownload.png" alt="cudnn"/></center><br />
<strong>上面的图片是后面更新文档的时候添加上的，跟我下面的安装列表有所区别，我之后在官网上没有找到对应的版本。但是直接在搜索框中输入下面的文件名是可以搜到的。</strong></p>
<div class="hlcode"><pre><span class="n">cudnn</span><span class="o">-</span><span class="mf">9.0</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">v7</span><span class="mf">.1</span><span class="p">.</span><span class="n">tar</span>   <span class="err">#</span> <span class="n">the</span> <span class="n">cuDNN</span> <span class="n">package</span>

<span class="n">libcudnn7_7</span><span class="mf">.1.3.16</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda9</span><span class="mf">.0</span><span class="n">_amd64</span><span class="o">-</span><span class="mf">2.</span><span class="n">deb</span>   <span class="err">#</span> <span class="n">runtime</span> <span class="n">library</span>

<span class="n">libcudnn7</span><span class="o">-</span><span class="n">dev_7</span><span class="mf">.1.3.16</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda9</span><span class="mf">.0</span><span class="n">_amd64</span><span class="o">-</span><span class="mf">2.</span><span class="n">deb</span>   <span class="err">#</span> <span class="n">developer</span> <span class="n">library</span>

<span class="n">libcudnn7</span><span class="o">-</span><span class="n">doc_7</span><span class="mf">.1.3.16</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda9</span><span class="mf">.0</span><span class="n">_amd64</span><span class="p">.</span><span class="n">deb</span>   <span class="err">#</span> <span class="n">the</span> <span class="n">code</span> <span class="n">samples</span> <span class="n">and</span> <span class="n">the</span> <span class="n">cuDNN</span> <span class="n">Library</span> <span class="n">User</span> <span class="n">Guide</span> 
</pre></div>


<p><strong><em>注意</em></strong><br />
在安装cudnn的时候要特别注意tensorflow目前支持的cudnn版本，我这边直接下载的是最新的，后面在安装完tensorflow-gpu 1.4.1之后调用cudnn时就出现了错误，错误提示为ImportError: libcudnn.so.6: cannot open shared object file: No such file or directory。<br />
我的解决方法是从官网上直接下载cudnn.6.0版本的，至于软链接等方式我试过了没有成功，后面有详细介绍，也可能是我添加环境变量错误导致。</p>
<p>根据对应的系统和cuda版本下载，我的系统是ubuntu16.04，cuda版本为9.0.最好再注意下tensorflow支持的cudnn版本，然后需要注意的是cuda的安装路径，如果在安装cuda使用的默认路径/usr/local/cuda/，则不需要修改。</p>
<p>在存放四个文件的下载目录下。</p>
<div class="hlcode"><pre><span class="cp"># 解压 cuDNN package.</span>
<span class="err">$</span> <span class="n">tar</span> <span class="o">-</span><span class="n">xzvf</span> <span class="n">cudnn</span><span class="o">-</span><span class="mf">9.0</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">-</span><span class="n">v7</span><span class="mf">.1</span><span class="p">.</span><span class="n">tgz</span>
<span class="cp"># 将下面的文件复制到 CUDA Toolkit 文件目录下。</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">cp</span> <span class="n">cuda</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cudnn</span><span class="p">.</span><span class="n">h</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">include</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">cp</span> <span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libcudnn</span><span class="o">*</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="n">a</span><span class="o">+</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">cudnn</span><span class="p">.</span><span class="n">h</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libcudnn</span><span class="o">*</span>
<span class="cp"># 安装 runtime library,</span>
<span class="n">sudo</span> <span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">libcudnn7_7</span><span class="mf">.1.3.16</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda9</span><span class="mf">.0</span><span class="n">_amd64</span><span class="o">-</span><span class="mf">2.</span><span class="n">deb</span>
<span class="cp"># 安装 developer library,</span>
<span class="n">sudo</span> <span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">libcudnn7</span><span class="o">-</span><span class="n">dev_7</span><span class="mf">.1.3.16</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda9</span><span class="mf">.0</span><span class="n">_amd64</span><span class="o">-</span><span class="mf">2.</span><span class="n">deb</span>
<span class="cp"># 安装 code samples and the cuDNN Library User Guide</span>
<span class="n">sudo</span> <span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">libcudnn7</span><span class="o">-</span><span class="n">doc_7</span><span class="mf">.1.3.16</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda9</span><span class="mf">.0</span><span class="n">_amd64</span><span class="p">.</span><span class="n">deb</span>
</pre></div>


<p><strong>附</strong> <a href="https://docs.nvidia.com/deeplearning/sdk/cudnn-install/index.html#install-linux">cuDNN官方的安装和验证教程</a></p>
<h2 id="cudnn_1">验证cudnn是否安装正确</h2>
<div class="hlcode"><pre><span class="mf">1.</span> <span class="err">将某一个</span> <span class="n">cuDNN</span> <span class="err">样例复制到某一可读写文件目录下</span>
<span class="err">$</span> <span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">cudnn_samples_v7</span><span class="o">/</span> <span class="err">$</span><span class="n">HOME</span>
<span class="mf">2.</span> <span class="err">进入该文件目录，</span> <span class="err">本文选择的是</span><span class="n">mnistCUDNN</span><span class="err">测试</span>
<span class="err">$</span> <span class="n">cd</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">cudnn_samples_v7</span><span class="o">/</span><span class="n">mnistCUDNN</span>
<span class="mf">3.</span> <span class="err">编译</span> <span class="n">mnistCUDNN</span> <span class="err">样例</span><span class="p">.</span>
<span class="err">$</span> <span class="n">make</span> <span class="n">clean</span> <span class="o">&amp;&amp;</span> <span class="n">make</span>
<span class="mf">4.</span> <span class="err">运行</span> <span class="n">mnistCUDNN</span> <span class="err">样例</span><span class="p">.</span>
<span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">mnistCUDNN</span>
<span class="mf">5.</span> <span class="err">如果安装成功，程序的最后则会显示</span>
<span class="n">Test</span> <span class="n">passed</span><span class="o">!</span>
</pre></div>


<p>详细运行结果如下图所示：<br />
<center><img src="/wiki/static/images/tensorgpu/mnistdnn.png" alt="mnist"/></center></p>
<h5 id="_2"><strong>版本更新</strong></h5>
<p><strong>UPDATE20190510</strong><br />
升级tensorflow之后(tensorflow-gpu 1.13)更新版本, 对应的cuda和cudnn</p>
<table>
<thead>
<tr>
<th align="center">NVIDIA driver</th>
<th align="center">CUDA</th>
<th align="center">CUDNN</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">418.74</td>
<td align="center">10.0</td>
<td align="center">7.4.2</td>
</tr>
</tbody>
</table>
<h3 id="_3">详细版本</h3>
<h3 id="nvidia-driver">NVIDIA Driver</h3>
<ul>
<li>NVIDIA-Linux-x86_64-418.74.run </li>
</ul>
<p><a href="http://www.nvidia.cn/Download/index.aspx?lang=cn">下载地址</a></p>
<h3 id="cuda_2">CUDA</h3>
<ul>
<li>cuda_10.0.130_410.48_linux.run</li>
</ul>
<p><a href="https://developer.nvidia.com/cuda-10.0-download-archive">下载地址</a></p>
<h3 id="cudnn_2">CUDNN</h3>
<ul>
<li>
<p>cudnn-10.0-linux-x64-v7.4.2.24.tgz</p>
</li>
<li>
<p>libcudnn7_7.4.2.24-1+cuda10.0_amd64.deb</p>
</li>
<li>
<p>libcudnn7-dev_7.4.2.24-1+cuda10.0_amd64.deb</p>
</li>
<li>
<p>libcudnn7-doc_7.4.2.24-1+cuda10.0_amd64.deb</p>
</li>
</ul>
<p><a href="https://developer.nvidia.com/rdp/cudnn-archive">下载地址</a></p>
<h1 id="gputensorflow">四、安装gpu版tensorflow</h1>
<p>本文使用的是virtualenv安装的tensorflow。<br />
现在tensorflow越来越成熟了，所以在虚拟环境下直接可以用<code>pip install --upgrade tensorflow-gpu</code>即可安装成功。<br />
安装完成后，进入python环境测试一下.</p>
<p>至此，基于Ubuntu的tensorflow-gpu版本就安装配置完成，下面就可以畅快的"吃鸡"啦。</p>
<h2 id="1_1">错误1</h2>
<p>tensorflow升级至1.7版本后，如果继续使用cuda 8.0则会报下面的错误：</p>
<div class="hlcode"><pre><span class="o">---------------------------------------------------------------------------</span>
<span class="nx">ImportError</span>                               <span class="nx">Traceback</span> <span class="p">(</span><span class="nx">most</span> <span class="nx">recent</span> <span class="nb">call</span> <span class="nb">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="nx">ipython</span><span class="na">-input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">64156</span><span class="nx">d691fe5</span><span class="o">&gt;</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="k">import</span> <span class="nx">tensorflow</span> <span class="nx">as</span> <span class="nx">tf</span>

<span class="p">/</span><span class="nb">home</span><span class="p">/</span><span class="nx">jerry</span><span class="p">/</span><span class="nx">workshop</span><span class="p">/</span><span class="nx">virtualenv</span><span class="p">/</span><span class="nx">tensor_jupyer</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">python2.7</span><span class="p">/</span><span class="nx">site</span><span class="na">-packages</span><span class="p">/</span><span class="nx">tensorflow</span><span class="p">/</span><span class="nx">__init__.py</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span><span class="p">()</span>
     <span class="mi">22</span> 
     <span class="mi">23</span> <span class="err">#</span> <span class="nx">pylint</span><span class="p">:</span> <span class="n">disable</span><span class="o">=</span><span class="nx">wildcard</span><span class="na">-import</span>
<span class="o">---&gt;</span> <span class="mi">24</span> <span class="nb">from</span> <span class="nx">tensorflow.python</span> <span class="k">import</span> <span class="o">*</span>  <span class="err">#</span> <span class="nx">pylint</span><span class="p">:</span> <span class="n">disable</span><span class="o">=</span><span class="nx">redefined</span><span class="na">-builtin</span>
     <span class="mi">25</span> <span class="err">#</span> <span class="nx">pylint</span><span class="p">:</span> <span class="n">enable</span><span class="o">=</span><span class="nx">wildcard</span><span class="na">-import</span>
     <span class="mi">26</span> 

<span class="p">/</span><span class="nb">home</span><span class="p">/</span><span class="nx">jerry</span><span class="p">/</span><span class="nx">workshop</span><span class="p">/</span><span class="nx">virtualenv</span><span class="p">/</span><span class="nx">tensor_jupyer</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">python2.7</span><span class="p">/</span><span class="nx">site</span><span class="na">-packages</span><span class="p">/</span><span class="nx">tensorflow</span><span class="p">/</span><span class="nx">python</span><span class="p">/</span><span class="nx">__init__.py</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span><span class="p">()</span>
     <span class="mi">47</span> <span class="k">import</span> <span class="nx">numpy</span> <span class="nx">as</span> <span class="nx">np</span>
     <span class="mi">48</span> 
<span class="o">---&gt;</span> <span class="mi">49</span> <span class="nb">from</span> <span class="nx">tensorflow.python</span> <span class="k">import</span> <span class="nx">pywrap_tensorflow</span>
     <span class="mi">50</span> 
     <span class="mi">51</span> <span class="err">#</span> <span class="nx">Protocol</span> <span class="nx">buffers</span>

<span class="p">/</span><span class="nb">home</span><span class="p">/</span><span class="nx">jerry</span><span class="p">/</span><span class="nx">workshop</span><span class="p">/</span><span class="nx">virtualenv</span><span class="p">/</span><span class="nx">tensor_jupyer</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">python2.7</span><span class="p">/</span><span class="nx">site</span><span class="na">-packages</span><span class="p">/</span><span class="nx">tensorflow</span><span class="p">/</span><span class="nx">python</span><span class="p">/</span><span class="nx">pywrap_tensorflow.py</span> <span class="k">in</span> <span class="o">&lt;</span><span class="nx">module</span><span class="o">&gt;</span><span class="p">()</span>
     <span class="mi">72</span> <span class="nb">for</span> <span class="nx">some</span> <span class="nx">common</span> <span class="nx">reasons</span> <span class="ow">and</span> <span class="nx">solutions.</span>  <span class="nb">Include</span> <span class="nx">the</span> <span class="nx">entire</span> <span class="nb">stack</span> <span class="nb">trace</span>
     <span class="mi">73</span> <span class="nx">above</span> <span class="nx">this</span> <span class="nb">error</span> <span class="nx">message</span> <span class="nx">when</span> <span class="nx">asking</span> <span class="nb">for</span> <span class="nx">help.</span><span class="s2">&quot;&quot;&quot; % traceback.format_exc()</span>
<span class="s2">---&gt; 74   raise ImportError(msg)</span>
<span class="s2">     75 </span>
<span class="s2">     76 # pylint: enable=wildcard-import,g-import-not-at-top,unused-import,line-too-long</span>

<span class="s2">ImportError: Traceback (most recent call last):</span>
<span class="s2">  File &quot;</span><span class="p">/</span><span class="nb">home</span><span class="p">/</span><span class="nx">jerry</span><span class="p">/</span><span class="nx">workshop</span><span class="p">/</span><span class="nx">virtualenv</span><span class="p">/</span><span class="nx">tensor_jupyer</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">python2.7</span><span class="p">/</span><span class="nx">site</span><span class="na">-packages</span><span class="p">/</span><span class="nx">tensorflow</span><span class="p">/</span><span class="nx">python</span><span class="p">/</span><span class="nx">pywrap_tensorflow.py</span><span class="s2">&quot;, line 58, in &lt;module&gt;</span>
<span class="s2">    from tensorflow.python.pywrap_tensorflow_internal import *</span>
<span class="s2">  File &quot;</span><span class="p">/</span><span class="nb">home</span><span class="p">/</span><span class="nx">jerry</span><span class="p">/</span><span class="nx">workshop</span><span class="p">/</span><span class="nx">virtualenv</span><span class="p">/</span><span class="nx">tensor_jupyer</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">python2.7</span><span class="p">/</span><span class="nx">site</span><span class="na">-packages</span><span class="p">/</span><span class="nx">tensorflow</span><span class="p">/</span><span class="nx">python</span><span class="p">/</span><span class="nx">pywrap_tensorflow_internal.py</span><span class="s2">&quot;, line 28, in &lt;module&gt;</span>
<span class="s2">    _pywrap_tensorflow_internal = swig_import_helper()</span>
<span class="s2">  File &quot;</span><span class="p">/</span><span class="nb">home</span><span class="p">/</span><span class="nx">jerry</span><span class="p">/</span><span class="nx">workshop</span><span class="p">/</span><span class="nx">virtualenv</span><span class="p">/</span><span class="nx">tensor_jupyer</span><span class="p">/</span><span class="nb">local</span><span class="p">/</span><span class="nx">lib</span><span class="p">/</span><span class="nx">python2.7</span><span class="p">/</span><span class="nx">site</span><span class="na">-packages</span><span class="p">/</span><span class="nx">tensorflow</span><span class="p">/</span><span class="nx">python</span><span class="p">/</span><span class="nx">pywrap_tensorflow_internal.py</span><span class="s2">&quot;, line 24, in swig_import_helper</span>
<span class="s2">    _mod = imp.load_module(&#39;_pywrap_tensorflow_internal&#39;, fp, pathname, description)</span>
<span class="s2">ImportError: libcublas.so.9.0: cannot open shared object file: No such file or directory</span>

<span class="s2">Failed to load the native TensorFlow runtime.</span>

<span class="s2">See https://www.tensorflow.org/install/install_sources#common_installation_problems</span>

<span class="s2">for some common reasons and solutions.  Include the entire stack trace</span>
<span class="s2">above this error message when asking for help.</span>
</pre></div>


<p>也就是说 tensorflow兼容的cuda也已经升级至9.0了，下面介绍下在ubuntu 16.04下升级安装cuda 9.0，这里本来想在cuda8.0的基础上直接覆盖安装cuda9.0的，结果没有成功，编译cuda实例源码的时候使用提示没有找到driver。在这之前一直是使用ubuntu系统本身的升级系统来更新nvidia驱动的，并没有使用源码安装显卡驱动。后来不停的重装cuda的过程中反而把系统给弄坏了，最后实在没办法重装系统。</p>
<p><strong>在这里我又跳到坑里了，tensorflow 1.7目前暂时不支持cudnn9.1，所以我又得重新安装cudnn了（4月17号更新）</strong><br />
<strong>注意，在安装cuda和dudnn的时候版本一定要一致。重装系统后，我装了cuda_9.0.176_384.81_linux和cudnn-9.0-linux-x64-v7.1，tensorflow的版本为1.7.0，安装过程中没有出现什么太大的问题，基本跟cuda8.0安装过程差不多。</strong></p>
<h2 id="20181016">更新(2018.10.16)</h2>
<p>在安装cudnn之后需要添加环境变量,上文提到了在/etc/profile中添加相应的语句,然后source.我在将tensorflow1.7升级到tensorflow1.10之后出现了问题一的情况,后面我将环境变量添加到~/.bashrc中,然后source之后问题没了.</p>
<p><strong>UPDATE20190511</strong><a href="https://tensorflow.google.cn/install/source">tensorlfow cuda cudnn的版本对应</a><br />
部分截图(UPGDATE20190710):<br />
<center><img src="/wiki/static/images/tensorgpu/version.jpg" alt="version"/></center></p>
<p><strong>UPDATE20190710</strong>*</p>
<h2 id="nccl2">NCCL2</h2>
<p>NCCL是Nvidia Collective multi-GPU Communication Library的简称，它是一个实现多GPU的collective communication通信（all-gather, reduce, broadcast）库，Nvidia做了很多优化，以在PCIe、Nvlink、InfiniBand上实现较高的通信速度。</p>
<h3 id="_4">下载</h3>
<p>NCCL的<a href="https://developer.nvidia.com/nccl/nccl-download">官网下载地址</a></p>
<p>需要根据本机系统的linux系统和cuda版本选择下载对应的NCCL版本.如下图所示.</p>
<p><center><img src="/wiki/static/images/tensorgpu/https-::developer.nvidia.com:nccl:nccl-download.jpg" alt="NCCL2"/></center></p>
<h3 id="_5">安装</h3>
<p>官网也给出了安装<a href="https://docs.nvidia.com/deeplearning/sdk/nccl-install-guide/index.html">installation guide</a></p>
<h4 id="step-1">step 1</h4>
<div class="hlcode"><pre><span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span><span class="n">_1</span><span class="o">-</span><span class="mi">1</span><span class="n">_amd64</span><span class="p">.</span><span class="n">deb</span>
</pre></div>


<p>运行结果如下:</p>
<div class="hlcode"><pre><span class="n">Selecting</span> <span class="n">previously</span> <span class="n">unselected</span> <span class="n">package</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span><span class="p">.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">181960</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Preparing</span> <span class="n">to</span> <span class="n">unpack</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span><span class="n">_1</span><span class="o">-</span><span class="mi">1</span><span class="n">_amd64</span><span class="p">.</span><span class="n">deb</span> <span class="p">...</span>
<span class="n">Unpacking</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span>

<span class="n">The</span> <span class="n">public</span> <span class="n">CUDA</span> <span class="n">GPG</span> <span class="n">key</span> <span class="n">does</span> <span class="n">not</span> <span class="n">appear</span> <span class="n">to</span> <span class="n">be</span> <span class="n">installed</span><span class="p">.</span>
<span class="n">To</span> <span class="n">install</span> <span class="n">the</span> <span class="n">key</span><span class="p">,</span> <span class="n">run</span> <span class="n">this</span> <span class="n">command</span><span class="o">:</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span><span class="o">/</span><span class="mf">7f</span><span class="n">a2af80</span><span class="p">.</span><span class="n">pub</span>
</pre></div>


<p>结果中提示CUDA GPG key没有安装, 需要执行下面的命令, 按照提示进行安装, 会返回一个OK:</p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span><span class="o">/</span><span class="mf">7f</span><span class="n">a2af80</span><span class="p">.</span><span class="n">pub</span>
</pre></div>


<p>然后重新安装, 运行结果如下:</p>
<div class="hlcode"><pre><span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">181970</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
<span class="n">Preparing</span> <span class="n">to</span> <span class="n">unpack</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span><span class="n">_1</span><span class="o">-</span><span class="mi">1</span><span class="n">_amd64</span><span class="p">.</span><span class="n">deb</span> <span class="p">...</span>
<span class="n">Unpacking</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">nccl</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">ubuntu1604</span><span class="o">-</span><span class="mf">2.4.7</span><span class="o">-</span><span class="n">ga</span><span class="o">-</span><span class="n">cuda10</span><span class="mf">.0</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span>
</pre></div>


<h4 id="step-2">step 2</h4>
<p>通过apt-get安装licnccl2, 如果需要使用NCCL编译程序, 还需要安装libnccl-dev.<br />
- 方法一<br />
使用下面的方式安装, 但是这种安装方式会<strong><em>将你的CUDA升级到最新版本</em></strong>(慎用).</p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libnccl2</span> <span class="n">libnccl</span><span class="o">-</span><span class="n">dev</span>
</pre></div>


<ul>
<li>方法二<br />
如果需要下载cuda对应版本的libnccl, 可以去下载NCCL的官网对应的cuda版本下面有指定的安装方式, 如下图所示:<br />
<center><img src="/wiki/static/images/tensorgpu/libnccl.jpg" alt="libnccl"/></center></li>
</ul>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">libnccl2</span><span class="o">=</span><span class="mf">2.4.7</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda10</span><span class="mf">.0</span> <span class="n">libnccl</span><span class="o">-</span><span class="n">dev</span><span class="o">=</span><span class="mf">2.4.7</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">cuda10</span><span class="mf">.0</span>
</pre></div>


<p>可能会出现下面的问题:</p>
<div class="hlcode"><pre><span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="p">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="p">...</span> <span class="n">Done</span>
<span class="nl">E:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">locate</span> <span class="n">package</span> <span class="n">libnccl2</span>
<span class="nl">E:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">locate</span> <span class="n">package</span> <span class="n">libnccl</span><span class="o">-</span><span class="n">dev</span>
</pre></div>


<p>可以执行下面的命令, 官网也有提示:</p>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>


<p>更新apt完成之后, 重新执行上一步的命令, 则会出现下面的运行结果.</p>
<div class="hlcode"><pre>root@gpyz-Super-Server:/home/gpyz/soft/li# apt-get install <span class="nv">libnccl2</span><span class="o">=</span>2.4.7-1+cuda10.0 libnccl-dev<span class="o">=</span>2.4.7-1+cuda10.0

Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  libnccl-dev libnccl2
0 upgraded, 2 newly installed, 0 to remove and 236 not upgraded.
Need to get 0 B/51.4 MB of archives.
After this operation, 220 MB of additional disk space will be used.
Get:1 file:/var/nccl-repo-2.4.7-ga-cuda10.0  libnccl2 2.4.7-1+cuda10.0 <span class="o">[</span>26.0 MB<span class="o">]</span>
Get:2 file:/var/nccl-repo-2.4.7-ga-cuda10.0  libnccl-dev 2.4.7-1+cuda10.0 <span class="o">[</span>25.4 MB<span class="o">]</span>
Selecting previously unselected package libnccl2.
<span class="o">(</span>Reading database ... 181970 files and directories currently installed.<span class="o">)</span>
Preparing to unpack .../libnccl2_2.4.7-1+cuda10.0_amd64.deb ...
Unpacking libnccl2 <span class="o">(</span>2.4.7-1+cuda10.0<span class="o">)</span> ...
Selecting previously unselected package libnccl-dev.
Preparing to unpack .../libnccl-dev_2.4.7-1+cuda10.0_amd64.deb ...
Unpacking libnccl-dev <span class="o">(</span>2.4.7-1+cuda10.0<span class="o">)</span> ...
Processing triggers <span class="k">for </span>libc-bin <span class="o">(</span>2.23-0ubuntu11<span class="o">)</span> ...
Setting up libnccl2 <span class="o">(</span>2.4.7-1+cuda10.0<span class="o">)</span> ...
Setting up libnccl-dev <span class="o">(</span>2.4.7-1+cuda10.0<span class="o">)</span> ...
Processing triggers <span class="k">for </span>libc-bin <span class="o">(</span>2.23-0ubuntu11<span class="o">)</span> ...
</pre></div>


<h1 id="_6">六、参考文献</h1>
<p><a href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html">CUDA官方安装教程</a><br />
<a href="https://docs.nvidia.com/deeplearning/sdk/cudnn-install/index.html#install-linux">cuDNN官方的安装和验证教程</a><br />
<a href="https://sthsf.github.io/wiki/Algorithm/DeepLearning/Tensorflow学习笔记/Tensorflow基础知识---Tensorflow-gpu版本安装.html">ubuntu下安装安装CUDA、cuDNN和tensotflow-gpu版本流程和问题总结</a><br />
<a href="https://www.cnblogs.com/gaowengang/p/6068788.html">Ubuntu 14.04 安装 CUDA 问题及解决</a><br />
<a href="http://blog.csdn.net/autocyz/article/details/52299889/">Ubuntu16.04+cuda8.0+caffe安装教程</a><br />
<a href="http://developer2.download.nvidia.com/compute/machine-learning/cudnn/secure/v7.0.5/prod/Doc/cuDNN-Installation-Guide.pdf?1RL9HfeGELbC3I_J6F0c5RpXvy64oKHaWa0lZVIHWvzPbVKxDtV4_ivmxT2kIC6z1lE_h2bxuVgKEhGGW6R5n_GHnem5SFsA9jQI6LWMt68_sjV_HuOFBYO3EHzSwncT9iu1uUqar7UMgfrEOjgjE6hYCZcNNzBLgWrFa5VCRa2DsE1G8htULohvZqErOvFXRw">CUDNN Installation Guide</a><br />
<a href="https://segmentfault.com/a/1190000008234390">Ubuntu16.04 下安装GPU版TensorFlow（包括Cuda和Cudnn）</a><br />
<a href="http://blog.csdn.net/u014696921/article/details/60140264">"libcudnn.so.5 cannot open shared object file: No such file or directory" </a><br />
<a href="http://blog.csdn.net/liukun321/article/details/6908635">ldconfig提示is not a symbolic link警告的去除方法 </a><br />
<a href="http://blog.csdn.net/binglel/article/details/70230276">Ubuntu16.04.1如何安装TensorFlow1.1.0（GPU版）</a><br />
<a href="https://github.com/tensorflow/tensorflow/issues/394">failed call to cuInit: CUDA_ERROR_UNKNOWN in python programs using Ubuntu bumblebee</a></p>
</div>
<div id="content-footer">created in <span class="create-date date"> 2018-06-01 03:00 </span></div>
<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  title: 'Tensorflow基础知识---Ubuntu16.04下安装安装CUDA9.0、cuDNN7.0和tensotflow-gpu 1.8.0以上的版本流程和问题总结',
  owner: 'sthsf',
  repo: 'wiki',
  oauth: {
    client_id: '086c54c5fd95adfdc372',
    client_secret: '2ad9ebe87b952d2c77fccf99c334881b91eaa73d',
  },
  // ...
  // For more available options, check out the documentation below
})
gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

</div>
<div id="footer">
            <span>
                Copyright © 2019 LiYu.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Fork me in <a href="https://github.com/sthsf/wiki" target="_blank"> github </a>.
            </span>
</div>


<!--百度统计-->
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?90e1dcdd1938573c19f9ff6521188e91";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


</body>
</html>